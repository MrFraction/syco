#
# NOTE: This configuration uses one ip for many domains, and will
# generate warnings in the apache error log that looks like this.
# "[warn] Init: SSL server IP/port conflict:"
# This is not a problem as long as the same SSL-cert can be used for
# all domains.
#
# This should be the first VirtualHosts included by httpd.conf
#

# We can use NameVirtual host for fareoffice, beacuse all
# domains/VirtualHosts are using the same wildcard cert.
NameVirtualHost *:80
NameVirtualHost *:443

# False-positive SQL injection.
SecRuleRemoveById 950901
SecRuleRemoveById 981173

# Redirect all HTTP requests to HTTPS if no specific
# virtualhost is specified.
<VirtualHost *:80>
  ServerName unknown.fareoffice.com

  DocumentRoot /var/www/html

  #ErrorLog logs/www.fareoffice.com-error_log
  ErrorLog syslog:local1
  CustomLog logs/www.fareoffice.com-access_log combined

  RewriteEngine on
  RewriteRule ^(.*)$ https://%{SERVER_NAME}$1 [R=301,L]
</VirtualHost>

#
# Rentalfront Backstage
#
<VirtualHost *:443>
  ServerName  backstage.fareoffice.com
  ServerAlias backstage-active-prod-nsg.fareoffice.com
  ServerAlias backstage-active-prod-tc.fareoffice.com
  ServerAlias backstage-active-uat-tp.fareoffice.com
  ServerAlias backstage-active-stable-tp.fareoffice.com
  ServerAlias backstage-active-int-tp.fareoffice.com

  Include conf.d/011-rentalfront.ssl.inc

  RewriteEngine on
  RewriteRule ^/rentalfront-backstage(.*)$ http://127.0.0.1:6080/rentalfront-backstage$1 [P]
  ProxyPassReverse /rentalfront-backstage http://127.0.0.1:6080/rentalfront-backstage
  ProxyTimeout 600

  RewriteCond %{REQUEST_URI} !^/sec
  RewriteCond %{REQUEST_URI} !^/error
  RewriteRule ^.*$ https://%{SERVER_NAME}/rentalfront-backstage$1 [R=301,L]

  # Disable modsecurity rules (TODO: Is it possible to fix the problems in java code?)
  SecRuleRemoveById 960032
  SecRuleRemoveById 960010

</VirtualHost>

<VirtualHost *:443>
  ServerName  backstage-passive-prod-nsg.fareoffice.com
  ServerAlias backstage-passive-prod-tc.fareoffice.com
  ServerAlias backstage-passive-uat-tp.fareoffice.com
  ServerAlias backstage-passive-stable-tp.fareoffice.com
  ServerAlias backstage-passive-int-tp.fareoffice.com

  Include conf.d/011-rentalfront.ssl.inc

  RewriteEngine on
  RewriteRule ^/rentalfront-backstage(.*)$ http://127.0.0.1:7080/rentalfront-backstage$1 [P]
  ProxyPassReverse /rentalfront-backstage http://127.0.0.1:7080/rentalfront-backstage
  ProxyTimeout 600

  RewriteCond %{REQUEST_URI} !^/sec
  RewriteCond %{REQUEST_URI} !^/error
  RewriteRule ^.*$ https://%{SERVER_NAME}/rentalfront-backstage$1 [R=301,L]

  # Disable modsecurity rules (TODO: Is it possible to fix the problems in java code?)
  SecRuleRemoveById 960032
  SecRuleRemoveById 960010

</VirtualHost>

#
# Rentalfront Web Service (FOX)
#
<VirtualHost *:443>
  ServerName  ws.fareoffice.com
  ServerAlias ws-active-prod-nsg.fareoffice.com
  ServerAlias ws-active-prod-tc.fareoffice.com
  ServerAlias ws-active-uat-tp.fareoffice.com
  ServerAlias ws-active-stable-tp.fareoffice.com
  ServerAlias ws-active-int-tp.fareoffice.com

  Include conf.d/011-rentalfront.ssl.inc

  RewriteEngine on

  # Works both for rentalfront-xml-client-1.0.0 and the FOX api.
  RewriteCond %{HTTP_HOST} ^ws-active-uat-tp\.fareoffice\.com$ [NC,OR]
  RewriteCond %{REMOTE_HOST} ^178.78.197.210$ [OR]
  RewriteCond %{REMOTE_HOST} ^192.168.0.
  RewriteRule ^/rentalfront-xml(.*)$ http://127.0.0.1:6080/rentalfront-xml$1 [P]
  ProxyPassReverse /rentalfront-xml http://127.0.0.1:6080/rentalfront-xml
  ProxyTimeout 600

  # TODO: Remove when the fox service has changed name.
  RewriteRule ^/fox(.*)$ http://127.0.0.1:6080/fox$1 [P]
  ProxyPassReverse /fox http://127.0.0.1:6080/fox

  RewriteCond %{REQUEST_URI} !^/sec
  RewriteCond %{REQUEST_URI} !^/error
  RewriteCond %{REQUEST_URI} !^/doc
  RewriteRule ^.*$ http://www.fareoffice.com/ [R=301,L]

  # Should only be used by The fellowship of Fareoffice
  <Directory /var/www/html/doc>
    AuthType Basic
    AuthName "Enter the documentation mine of Fareoffice."
    AuthUserFile /etc/httpd/password/htpassword
    Require user durinsbane
  </Directory>

</VirtualHost>

<VirtualHost *:443>
  ServerName  ws-passive-prod-nsg.fareoffice.com
  ServerAlias ws-passive-prod-tc.fareoffice.com
  ServerAlias ws-passive-uat-tp.fareoffice.com
  ServerAlias ws-passive-stable-tp.fareoffice.com
  ServerAlias ws-passive-int-tp.fareoffice.com

  Include conf.d/011-rentalfront.ssl.inc

  RewriteEngine on

  # Works both for rentalfront-xml-client-1.0.0 and the FOX api.
  RewriteCond %{REMOTE_HOST} ^178.78.197.210$ [OR]
  RewriteCond %{REMOTE_HOST} ^192.168.0.
  RewriteRule ^/rentalfront-xml(.*)$ http://127.0.0.1:6080/rentalfront-xml$1 [P]
  ProxyPassReverse /rentalfront-xml http://127.0.0.1:6080/rentalfront-xml
  ProxyTimeout 600

  # TODO: Remove when the fox service has changed name.
  RewriteRule ^/fox(.*)$ http://127.0.0.1:7080/fox$1 [P]
  ProxyPassReverse /fox http://127.0.0.1:7080/fox

  RewriteCond %{REQUEST_URI} !^/sec
  RewriteCond %{REQUEST_URI} !^/error
  RewriteCond %{REQUEST_URI} !^/doc
  RewriteRule ^.*$ http://www.fareoffice.com/ [R=301,L]

  # Should only be used by The fellowship of Fareoffice
  <Directory /var/www/html/doc>
    AuthType Basic
    AuthName "Enter the documentation mine of Fareoffice."
    AuthUserFile /etc/httpd/password/htpassword
    Require user durinsbane
  </Directory>

</VirtualHost>
